
error_log  /var/log/nginx/error.log warn;

server {

  listen 81;
  
  location / {
    root   /usr/share/nginx/html;
    index  index.html index.htm;
    try_files $uri $uri/ /index.html;
  }
  # error_page   500 502 503 504  /50x.html;

  # location = /50x.html {
  #   root   /usr/share/nginx/html;
  # }
}


upstream backend {
    least_conn;
    zone inventory_service 64k;

    server backend:5001 max_fails=2 fail_timeout=10s;

    keepalive 32;
    keepalive_timeout 20s;
    keepalive_requests 20;
    
}
upstream sendEmail {
    least_conn;
    zone inventory_service 64k;

    server server_send_email:5002 max_fails=2 fail_timeout=10s;

    keepalive 32;
    keepalive_timeout 20s;
    keepalive_requests 20;
}

proxy_cache_path /etc/nginx/cache keys_zone=my_cache:10m max_size=100m loader_threshold=300 inactive=60m use_temp_path=off;

server {
    listen       80;
    listen  [::]:80;
    server_name  localhost;

    error_log  /var/log/nginx/error_log;

    location / {
        # rewrite /main/(.*) /$1 break;
        # proxy_cache my_cache;
        # proxy_cache_valid 200 30s;
        # proxy_cache_methods GET HEAD POST;
        # proxy_cache_min_uses 1;
        # proxy_cache_lock on;
        # proxy_cache_use_stale error timeout updating http_502 http_503 http_504;
        access_log /var/log/nginx/backend.log main;

        proxy_pass http://backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_set_header   Host $host;
        proxy_redirect     off;
        proxy_set_header   X-Real-IP $remote_addr;
        proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Host $server_name;

        error_log  /var/log/nginx/backend.error_log  warn;

    }

    location /send {
        access_log /var/log/nginx/sendemail.log main;

        proxy_pass http://sendEmail/api/email;
        proxy_ignore_headers Set-Cookie;
        proxy_set_header   X-Real-IP $remote_addr;
        proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Host $server_name;

        error_log  /var/log/nginx/sendemail.error_log  warn;
    }
}
